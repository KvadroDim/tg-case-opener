<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Case Simulator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a2e;
            color: white;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .balance {
            background: rgba(255, 215, 0, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-weight: bold;
        }
        
        .cases-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
        }
        
        .cases-container::-webkit-scrollbar {
            display: none;
        }
        
        .case {
            min-width: 150px;
            background: linear-gradient(135deg, #2a2a4a, #1e1e3a);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        .case:hover {
            transform: scale(1.05);
        }
        
        .case-image {
            width: 100%;
            height: 100px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 10px;
        }
        
        .case-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .case-price {
            color: gold;
            font-size: 14px;
        }
        
        .roulette-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .roulette {
            width: 100%;
            height: 150px;
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .roulette-items {
            display: flex;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            transition-timing-function: cubic-bezier(0.1, 0.8, 0.2, 1);
        }
        
        .roulette-item {
            width: 120px;
            height: 100%;
            margin: 0 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .roulette-item-image {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .result {
            display: none;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            max-width: 80%;
            border: 2px solid gold;
        }
        
        .result-image {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .result-name {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            color: gold;
        }
        
        .result-value {
            margin-bottom: 20px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        button {
            background: linear-gradient(135deg, #6e45e2, #88d3ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        .inventory-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(106, 90, 205, 0.8);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .rarity-common { color: #b0b0b0; }
        .rarity-uncommon { color: #4caf50; }
        .rarity-rare { color: #2196f3; }
        .rarity-epic { color: #9c27b0; }
        .rarity-legendary { color: #ff9800; }
        .rarity-mythic { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÅ Case Simulator</h1>
            <div class="balance">
                <span>‚≠ê</span>
                <span id="balance">1000</span>
            </div>
        </div>
        
        <div class="cases-container" id="casesContainer">
            <!-- Cases will be added via JS -->
        </div>
    </div>
    
    <div class="roulette-container" id="rouletteContainer">
        <div class="roulette">
            <div class="roulette-items" id="rouletteItems">
                <!-- Roulette items will be added via JS -->
            </div>
        </div>
    </div>
    
    <div class="result" id="result">
        <div class="result-image" id="resultImage"></div>
        <div class="result-name" id="resultName"></div>
        <div class="result-value" id="resultValue"></div>
        <div class="buttons">
            <button id="sellBtn">–ü—Ä–æ–¥–∞—Ç—å</button>
            <button id="keepBtn">–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        </div>
    </div>
    
    <div class="inventory-btn" id="inventoryBtn">üéí</div>
    
    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // User data
        let userData = {
            balance: 1000,
            inventory: [],
            tgUserId: tg.initDataUnsafe?.user?.id || Math.floor(Math.random() * 1000000)
        };
        
        // Cases data with probabilities
        const cases = [
            {
                id: 1,
                name: "–û–±—ã—á–Ω—ã–π –∫–µ–π—Å",
                price: 100,
                image: "üì¶",
                rewards: [
                    { id: "sticker1", name: "–û–±—ã—á–Ω—ã–π —Å—Ç–∏–∫–µ—Ä", value: 50, image: "üòÄ", rarity: "common", probability: 50 },
                    { id: "emoji1", name: "–ù–∞–±–æ—Ä —ç–º–æ–¥–∑–∏", value: 80, image: "üòé", rarity: "uncommon", probability: 30 },
                    { id: "bg1", name: "–§–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è", value: 150, image: "üé®", rarity: "rare", probability: 15 },
                    { id: "badge1", name: "–ë–µ–π–¥–∂", value: 300, image: "üõ°Ô∏è", rarity: "epic", probability: 4 },
                    { id: "vip1", name: "VIP-—Å—Ç–∞—Ç—É—Å", value: 1000, image: "üëë", rarity: "legendary", probability: 1 }
                ]
            },
            {
                id: 2,
                name: "–ü—Ä–µ–º–∏—É–º –∫–µ–π—Å",
                price: 500,
                image: "üíé",
                rewards: [
                    { id: "sticker2", name: "–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∏–∫–µ—Ä", value: 200, image: "‚ú®", rarity: "uncommon", probability: 40 },
                    { id: "emoji2", name: "–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —ç–º–æ–¥–∑–∏", value: 300, image: "üî•", rarity: "rare", probability: 30 },
                    { id: "bg2", name: "–ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω", value: 500, image: "üåÄ", rarity: "epic", probability: 20 },
                    { id: "badge2", name: "–ó–æ–ª–æ—Ç–æ–π –±–µ–π–¥–∂", value: 1000, image: "üèÜ", rarity: "legendary", probability: 9 },
                    { id: "vip2", name: "–ü—Ä–µ–º–∏—É–º-—Å—Ç–∞—Ç—É—Å", value: 5000, image: "üíé", rarity: "mythic", probability: 1 }
                ]
            }
        ];
        
        // Current case and reward
        let currentCase = null;
        let currentReward = null;
        let spinning = false;
        
        // Initialize app
        function init() {
            loadUserData();
            renderCases();
            setupEventListeners();
            
            if (tg.platform !== "unknown") {
                tg.MainButton.setText("–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å");
                tg.MainButton.onClick(showProfile);
                tg.MainButton.show();
            }
        }
        
        // Load user data
        function loadUserData() {
            const savedData = localStorage.getItem(`tgCaseUser_${userData.tgUserId}`);
            if (savedData) {
                userData = JSON.parse(savedData);
                updateBalance();
            }
        }
        
        // Save user data
        function saveUserData() {
            localStorage.setItem(`tgCaseUser_${userData.tgUserId}`, JSON.stringify(userData));
        }
        
        // Render cases
        function renderCases() {
            const container = document.getElementById('casesContainer');
            container.innerHTML = '';
            
            cases.forEach(caseItem => {
                const caseElement = document.createElement('div');
                caseElement.className = 'case';
                caseElement.innerHTML = `
                    <div class="case-image">${caseItem.image}</div>
                    <div class="case-name">${caseItem.name}</div>
                    <div class="case-price">${caseItem.price} ‚≠ê</div>
                `;
                
                caseElement.addEventListener('click', () => {
                    if (!spinning) openCase(caseItem);
                });
                
                container.appendChild(caseElement);
            });
        }
        
        // Open case
        function openCase(caseItem) {
            if (userData.balance < caseItem.price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }
            
            currentCase = caseItem;
            userData.balance -= caseItem.price;
            updateBalance();
            saveUserData();
            
            showRoulette(caseItem);
        }
        
        // Show roulette
        function showRoulette(caseItem) {
            spinning = true;
            const container = document.getElementById('rouletteContainer');
            const itemsContainer = document.getElementById('rouletteItems');
            
            // Clear previous items
            itemsContainer.innerHTML = '';
            
            // Create 50 items (for smooth animation)
            const itemsToShow = 50;
            const rewards = [];
            
            // Fill rewards array according to probabilities
            caseItem.rewards.forEach(reward => {
                for (let i = 0; i < reward.probability; i++) {
                    rewards.push(reward);
                }
            });
            
            // Create roulette items
            for (let i = 0; i < itemsToShow; i++) {
                const reward = rewards[Math.floor(Math.random() * rewards.length)];
                const item = document.createElement('div');
                item.className = 'roulette-item';
                item.innerHTML = `
                    <div class="roulette-item-image ${'rarity-' + reward.rarity}">${reward.image}</div>
                    <div>${reward.value}‚≠ê</div>
                `;
                itemsContainer.appendChild(item);
            }
            
            // Show roulette
            container.style.display = 'flex';
            
            // Start spinning
            setTimeout(() => {
                spinRoulette(caseItem);
            }, 500);
        }
        
        // Spin roulette
        function spinRoulette(caseItem) {
            const itemsContainer = document.getElementById('rouletteItems');
            const duration = 3000; // 3 seconds
            const startTime = Date.now();
            
            // Select random reward (weighted by probability)
            const random = Math.random() * 100;
            let probabilitySum = 0;
            
            for (const reward of caseItem.rewards) {
                probabilitySum += reward.probability;
                if (random <= probabilitySum) {
                    currentReward = reward;
                    break;
                }
            }
            
            // Find index of the selected reward in the visible items
            const rewardIndex = Math.floor(Math.random() * 10) + 20; // Land in the middle
            const itemWidth = 130; // roulette-item width + margin
            
            // Calculate target position (center the selected item)
            const targetPosition = -(rewardIndex * itemWidth) + (window.innerWidth / 2 - itemWidth / 2);
            
            // Animation function
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                // Calculate current position
                const distance = -5000 + (easeOut * (5000 + targetPosition));
                
                itemsContainer.style.transform = `translateX(${distance}px)`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Show result after spinning
                    setTimeout(() => {
                        showResult();
                        spinning = false;
                    }, 500);
                }
            }
            
            animate();
        }
        
        // Show result
        function showResult() {
            document.getElementById('resultImage').className = `result-image rarity-${currentReward.rarity}`;
            document.getElementById('resultImage').textContent = currentReward.image;
            document.getElementById('resultName').textContent = currentReward.name;
            document.getElementById('resultValue').textContent = `–¶–µ–Ω–∞: ${currentReward.value} ‚≠ê`;
            document.getElementById('result').style.display = 'block';
        }
        
        // Close roulette
        function closeRoulette() {
            document.getElementById('rouletteContainer').style.display = 'none';
            document.getElementById('result').style.display = 'none';
        }
        
        // Sell reward
        function sellReward() {
            userData.balance += currentReward.value;
            updateBalance();
            saveUserData();
            closeRoulette();
            
            if (tg.platform !== "unknown") {
                tg.showAlert(`–í—ã –ø—Ä–æ–¥–∞–ª–∏ ${currentReward.name} –∑–∞ ${currentReward.value} ‚≠ê`);
            } else {
                alert(`–í—ã –ø—Ä–æ–¥–∞–ª–∏ ${currentReward.name} –∑–∞ ${currentReward.value} ‚≠ê`);
            }
        }
        
        // Keep reward
        function keepReward() {
            userData.inventory.push(currentReward);
            saveUserData();
            closeRoulette();
            
            if (tg.platform !== "unknown") {
                tg.showAlert(`üéâ ${currentReward.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!`);
            } else {
                alert(`üéâ ${currentReward.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!`);
            }
        }
        
        // Show profile
        function showProfile() {
            tg.showPopup({
                title: `–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`,
                message: `‚≠ê –ó–≤—ë–∑–¥: ${userData.balance}\nüéÅ –ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${userData.inventory.length}`,
                buttons: [
                    { id: 'addStars', type: 'default', text: '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å' },
                    { id: 'close', type: 'cancel' }
                ]
            }, (btnId) => {
                if (btnId === 'addStars') {
                    if (tg.platform !== "unknown") {
                        tg.openInvoice({
                            title: "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞",
                            description: "–ö—É–ø–∏—Ç—å –∑–≤—ë–∑–¥—ã Telegram",
                            currency: "USD",
                            prices: [{ label: "100 ‚≠ê", amount: 100 }],
                            payload: JSON.stringify({ userId: userData.tgUserId, type: "stars" })
                        });
                    } else {
                        alert("–í Telegram –æ—Ç–∫—Ä–æ–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∑–≤—ë–∑–¥");
                    }
                }
            });
        }
        
        // Update balance display
        function updateBalance() {
            document.getElementById('balance').textContent = userData.balance;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('sellBtn').addEventListener('click', sellReward);
            document.getElementById('keepBtn').addEventListener('click', keepReward);
            document.getElementById('inventoryBtn').addEventListener('click', () => {
                // Implement inventory view here
                alert(`–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ ${userData.inventory.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤`);
            });
            
            // Handle Telegram events
            if (tg.platform !== "unknown") {
                tg.onEvent('invoiceClosed', (event) => {
                    if (event.status === 'paid') {
                        userData.balance += 100; // Add stars
                        updateBalance();
                        saveUserData();
                        tg.showAlert("–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ 100 ‚≠ê!");
                    }
                });
            }
        }
        
        // Initialize when ready
        if (tg.initDataUnsafe) {
            init();
        } else {
            tg.ready();
            tg.onEvent('viewportChanged', init);
        }
    </script>
</body>
</html>
